<Window x:Class="TreeListVIew.Views.TreeGridDemo"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:TreeListVIew.Views"
        xmlns:convert="clr-namespace:TreeListVIew.ValueConverter"
        xmlns:models="clr-namespace:TreeListVIew.Models"
        mc:Ignorable="d" Name="baseWin"
        Title="TreeGridDemo" Height="450" Width="800">
    <Window.Resources>
        <!--保证首列铺满剩余空间-->
        <convert:SubtractionConverter x:Key="SubtractionConverter" />
        <!--控制TreeViewItem的缩进-->
        <convert:LevelToMarginConverter x:Key="LevelToMarginConverter" />

        <!--展开按钮模板-->
        <ControlTemplate x:Key="ExpanderToggleButton" TargetType="ToggleButton">
            <Border VerticalAlignment="Center" HorizontalAlignment="Left" Cursor="Hand">
                <Path Name="path" Data="M 5,4 L 5,11 L 11,7.5 Z" Fill="Black" />
            </Border>

            <ControlTemplate.Triggers>
                <Trigger Property="IsChecked" Value="true">
                    <Setter TargetName="path" Property="Data" Value="M 4,5 L 11,5 L 7.5,11 Z" />
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <!--树形表头模板-->
        <DataTemplate x:Key="TreeHeader" d:DataType="{x:Type models:TreeViewItem}">
            <Border BorderBrush="#ccc" BorderThickness="0,0,.5,.5">
                <DockPanel>
                    <ToggleButton x:Name="Expander" Width="20" Height="20" DockPanel.Dock="Left"
                           Margin="{Binding Level,Converter={StaticResource LevelToMarginConverter}}"
                           IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type TreeViewItem}}}"
                           Template="{StaticResource ExpanderToggleButton}" />
                    <TextBlock x:Name="txtb_title" VerticalAlignment="Center" Text="{Binding Name}" Cursor="Hand" />
                </DockPanel>
            </Border>

            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding HasItems, RelativeSource={RelativeSource AncestorType={x:Type TreeViewItem}}}" Value="False">
                    <Setter TargetName="Expander" Property="Visibility" Value="Hidden" />
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate x:Key="StartDateTemp" d:DataType="{x:Type models:TreeViewItem}">
            <Border BorderBrush="#ccc" BorderThickness="0,0,.5,.5">
                <TextBlock x:Name="txtb_count" VerticalAlignment="Center" TextAlignment="Center" Text="{Binding StartDate}"/>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="EndDateTemp" d:DataType="{x:Type models:TreeViewItem}">
            <Border BorderBrush="#ccc" BorderThickness="0,0,.5,.5">
                <TextBlock x:Name="txtb_count" VerticalAlignment="Center" TextAlignment="Center" Text="{Binding EndDate}"/>
            </Border>
        </DataTemplate>
        

        <GridViewColumnCollection x:Key="gvcc">
            <GridViewColumn Header="名称"
                     Width="{Binding ActualWidth,RelativeSource={RelativeSource Mode=FindAncestor,AncestorType=Page}, Converter={StaticResource SubtractionConverter},ConverterParameter=160}"
                     CellTemplate="{StaticResource TreeHeader}"/>
            <GridViewColumn Header="开始日期"  
                     CellTemplate="{StaticResource StartDateTemp}"
                     Width="80" />
            <GridViewColumn Header="结束日期"  
                     CellTemplate="{StaticResource EndDateTemp}"
                     Width="80" />
        </GridViewColumnCollection>

        <!--样式优化-->
        <Style TargetType="ContentPresenter">
            <EventSetter Event="Loaded" Handler="ContentPresenter_Loaded" />
        </Style>

        <!--重新写TreeViewItem-->
        <Style TargetType="{x:Type TreeViewItem}">
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="IsExpanded" Value="{Binding IsExpanded}" />
            <Setter Property="IsSelected" Value="{Binding IsSelected}" />

            <!--定义模板-->
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TreeViewItem}">
                        <StackPanel>
                            <Border Name="Bd">
                                <GridViewRowPresenter Margin="0" x:Name="PART_Header" Content="{TemplateBinding Header}" Columns="{StaticResource gvcc}" />
                            </Border>
                            <ItemsPresenter x:Name="ItemsHost" />
                        </StackPanel>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded" Value="False">
                                <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed" />
                            </Trigger>

                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="HasHeader" Value="false"/>
                                    <Condition Property="Width" Value="Auto"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="PART_Header" Property="MinWidth" Value="75"/>
                            </MultiTrigger>

                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}" />
                                <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.HighlightTextBrushKey}}" />
                            </Trigger>

                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsSelected" Value="True" />
                                    <Condition Property="IsSelectionActive" Value="False" />
                                </MultiTrigger.Conditions>

                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource {x:Static SystemColors.ControlBrushKey}}" />
                                <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}" />
                            </MultiTrigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="{x:Type TreeView}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TreeView}">
                        <ScrollViewer>
                            <StackPanel>
                                <GridViewHeaderRowPresenter Columns="{StaticResource gvcc}" />
                                <ItemsPresenter />
                            </StackPanel>
                        </ScrollViewer>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <TreeView ItemsSource="{Binding DisplayTree,ElementName=baseWin}">
            <TreeView.ItemTemplate>
                <HierarchicalDataTemplate ItemsSource="{Binding Children}" />
            </TreeView.ItemTemplate>
        </TreeView>
    </Grid>
</Window>
